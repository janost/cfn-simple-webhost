AWSTemplateFormatVersion: "2010-09-09"
Description: Simple web hosting stack that provides an EC2 web instance, RDS MySQL, ElastiCache and related resources.

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Network
        Parameters: [WebAZ, DBAZ, SSHLocation]
      - Label:
          default: Web instance
        Parameters: [CreateWebInstance, AttachDataVolume, InstanceType, InstanceAMI, KeyName, WebInstanceRootDiskSize, WebInstanceDataDiskSize, WebInstanceSwapDiskSize]
      - Label:
          default: DB instance
        Parameters: [DBInstanceClass, DBAllocatedStorage, MySQLVersion, DBParameterGroupFamily, DBName, DBUser, DBPassword, DBBackupRetentionPeriod]
      - Label:
          default: ElastiCache
        Parameters: [MemcachedVersion, CacheNodeType]
      - Label:
          default: SMTP settings
        Parameters: [SMTPHostname, SMTPPort, SMTPTLS]

Parameters:
  WebAZ:
    Description: Availability zone for the web instance.
    Type: AWS::EC2::AvailabilityZone::Name
  InstanceType:
    Description: EC2 instance type of the web instance.
    Type: String
    Default: t2.micro
  InstanceAMI:
    Description: Instance AMI to build the web instance from (generated by packer from `base-image.json`).
    Type: AWS::EC2::Image::Id
    Default: ami-086fee459af359204
  KeyName:
    Description: EC2 KeyPair to enable SSH access to the web instance.
    Type: AWS::EC2::KeyPair::KeyName
  CreateWebInstance:
    Description: Cycle false/true on this property to replace your web instance. WARNING! Setting this to true will DESTROY your instance!
    Type: String
    AllowedValues: [true, false]
    Default: true
  WebInstanceRootDiskSize:
    Description: Size of the web instance's root disk
    Type: Number
    Default: 8
  WebInstanceDataDiskSize:
    Description:  Size of the web instance's data EBS volume.
    Type: Number
    Default: 10
  WebInstanceSwapDiskSize:
    Description:  Size of the web instance's swap EBS volume.
    Type: Number
    Default: 4
  DBAZ:
    Description: Availability zones for the DB instance (needs 2 AZs).
    Type: List<AWS::EC2::AvailabilityZone::Name>
  DBAllocatedStorage:
    Description: Allocated storage for the DB instance in GiB.
    Type: Number
    Default: 20
  DBInstanceClass:
    Description: Instance type of the DB instance.
    Type: String
    Default: db.t2.micro
  MySQLVersion:
    Description: RDS MySQL version.
    Type: String
    Default: 5.7.24
  DBParameterGroupFamily:
    Description: RDS MySQL parameter group family.
    Type: String
    Default: mysql5.7
  DBName:
    Description: Name of the database to create.
    Type: String
    Default: web
  DBUser:
    Description: Database admin username.
    Type: String
    Default: root
  DBPassword:
    Description: Database admin password.
    Type: String
    NoEcho: true
  DBBackupRetentionPeriod:
    Description: Number of days to retain DB backups.
    Type: Number
    Default: 30
  SMTPHostname:
    Description: Hostname of the SMTP server.
    Type: String
    Default: email-smtp.eu-west-1.amazonaws.com
  SMTPPort:
    Description: Port of the SMTP server.
    Type: Number
    Default: 587
  SMTPTLS:
    Description: Is TLS enabled on the SMTP server?
    Type: String
    AllowedValues: [true, false]
    Default: true
  SSHLocation:
    Description: The IP address range that can be used to SSH to the web instance.
    Type: String
    MinLength: 9
    MaxLength: 18
    Default: "0.0.0.0/0"
    AllowedPattern: "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})"
  AttachDataVolume:
    Description: Attach data volume to the web instance. This is here because VolumeAttachments can't be updated, so you can't replace the web instance while this attachment exists.
    Type: String
    AllowedValues: [true, false]
    Default: true
  MemcachedVersion:
    Description: ElastiCache memcached version.
    Type: String
    Default: 1.5.10
  CacheNodeType:
    Description: Instance type of the ElastiCache node.
    Type: String
    Default: cache.t2.micro

Conditions:
  cAttachDataVolume: !And [ !Equals [ !Ref CreateWebInstance, true ], !Equals [ !Ref AttachDataVolume, true ] ]
  cCreateWebInstance: !Equals [ !Ref CreateWebInstance, true ]

Resources:
  MainVPC:
    Type: AWS::EC2::VPC
    Properties:
      Tags:
      - Key: Name
        Value: !Join ['-', [!Ref 'AWS::StackName', VPC]]
      CidrBlock: '10.1.0.0/16'
      EnableDnsSupport: 'true'
      EnableDnsHostnames: 'true'

  MainIGW:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
      - Key: Name
        Value: !Join ['-', [!Ref 'AWS::StackName', MainIGW]]

  MainIGWAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId: !Ref MainIGW
      VpcId: !Ref MainVPC

  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone: !Ref WebAZ
      CidrBlock: '10.1.1.0/24'
      MapPublicIpOnLaunch: true
      Tags:
      - Key: Name
        Value: !Join ['-', [!Ref 'AWS::StackName', PublicSubnet1]]
      VpcId: !Ref MainVPC

  PublicRouteTable1:
    Type: AWS::EC2::RouteTable
    DependsOn: MainIGW
    Properties:
      Tags:
      - Key: Name
        Value: !Join ['-', [!Ref 'AWS::StackName', PublicRouteTable1]]
      VpcId: !Ref MainVPC

  PublicRouteTableAssociation1:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTable1
      SubnetId: !Ref PublicSubnet1

  PublicIGWRoute1:
    Type: AWS::EC2::Route
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref MainIGW
      RouteTableId: !Ref PublicRouteTable1

  DBSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone: !Select [0, !Ref DBAZ]
      CidrBlock: '10.1.10.0/24'
      Tags:
      - Key: Name
        Value: !Join ['-', [!Ref 'AWS::StackName', DBSubnet1]]
      VpcId: !Ref MainVPC

  DBSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone: !Select [1, !Ref DBAZ]
      CidrBlock: '10.1.11.0/24'
      Tags:
      - Key: Name
        Value: !Join ['-', [!Ref 'AWS::StackName', DBSubnet2]]
      VpcId: !Ref MainVPC

  WebDataVolume:
    Type: AWS::EC2::Volume
    Properties:
      AvailabilityZone: !Ref WebAZ
      VolumeType: gp2
      Encrypted: true
      KmsKeyId: !GetAtt EncryptionKey.Arn
      Size: !Ref WebInstanceDataDiskSize
      Tags:
        - Key: Name
          Value: !Join ['-', [!Ref 'AWS::StackName', WebDataVolume]]

  WebDataVolumeAttachment:
    Condition: cAttachDataVolume
    Type: AWS::EC2::VolumeAttachment
    Properties:
      Device: '/dev/xvdb'
      InstanceId: !Ref WebInstance
      VolumeId: !Ref WebDataVolume

  WebInstanceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - ec2.amazonaws.com
          Action:
          - sts:AssumeRole
      Path: /
      Policies:
      - PolicyName: LogPolicy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
            - logs:DescribeLogStreams
            Resource: arn:aws:logs:*:*:*
      - PolicyName: EC2VolumeTagPolicy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action: ec2:DescribeVolumes
            Resource: '*'
          - Effect: Allow
            Action: ec2:CreateTags
            Resource: arn:aws:ec2:*:*:volume/*

  WebInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: /
      Roles:
      - !Ref WebInstanceRole

  WebInstance:
    Condition: cCreateWebInstance
    Type: AWS::EC2::Instance
    Properties:
      AvailabilityZone: !Ref WebAZ
      ImageId: !Ref InstanceAMI
      InstanceType: !Ref InstanceType
      KeyName: !Ref KeyName
      IamInstanceProfile: !Ref WebInstanceProfile
      BlockDeviceMappings:
        - DeviceName: '/dev/xvda'
          Ebs:
            VolumeType: gp2
            Encrypted: true
            DeleteOnTermination: true
            VolumeSize: !Ref WebInstanceRootDiskSize
        - DeviceName: '/dev/xvds'
          Ebs:
            VolumeType: gp2
            Encrypted: true
            DeleteOnTermination: true
            VolumeSize: !Ref WebInstanceSwapDiskSize
      Tags:
        - Key: Stack
          Value: !Ref 'AWS::StackId'
        - Key: Name
          Value: !Join ['-', [!Ref 'AWS::StackName', WebInstance]]
      SecurityGroupIds: [ !Ref WebInstanceSecurityGroup, !Ref WebDBSecurityGroup ]
      SubnetId: !Ref PublicSubnet1
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash

          /opt/aws/bin/cfn-init -v --stack ${AWS::StackName} --resource WebInstance --region ${AWS::Region}

          DATA_DEVICE="/dev/xvdb"
          SWAP_DEVICE="/dev/xvds"
          DATA_MOUNTPOINT="/data"

          echo "Getting metadata from AWS API...."
          INSTANCE_ID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)
          PUBLIC_IPV4=$(curl http://169.254.169.254/latest/meta-data/public-ipv4)
          AVAIL_ZONE=$(curl http://169.254.169.254/latest/meta-data/placement/availability-zone)
          AWS_REGION="$(echo $AVAIL_ZONE | sed 's/.$//')"

          /var/awslogs/bin/aws configure set default.region $AWS_REGION

          echo "Tagging our volumes..."
          ROOT_VOLUME=$(/var/awslogs/bin/aws ec2 describe-volumes --query 'Volumes[*].VolumeId' --filters Name=attachment.instance-id,Values=$INSTANCE_ID Name=attachment.device,Values=/dev/xvda --output text)
          DATA_VOLUME=$(/var/awslogs/bin/aws ec2 describe-volumes --query 'Volumes[*].VolumeId' --filters Name=attachment.instance-id,Values=$INSTANCE_ID Name=attachment.device,Values=$DATA_DEVICE --output text)
          SWAP_VOLUME=$(/var/awslogs/bin/aws ec2 describe-volumes --query 'Volumes[*].VolumeId' --filters Name=attachment.instance-id,Values=$INSTANCE_ID Name=attachment.device,Values=$SWAP_DEVICE --output text)
          /var/awslogs/bin/aws ec2 create-tags --resources $ROOT_VOLUME --tags Key=Name,Value=root-${AWS::StackName}-$INSTANCE_ID
          /var/awslogs/bin/aws ec2 create-tags --resources $DATA_VOLUME --tags Key=Name,Value=data-${AWS::StackName}-$INSTANCE_ID
          /var/awslogs/bin/aws ec2 create-tags --resources $SWAP_VOLUME --tags Key=Name,Value=swap-${AWS::StackName}-$INSTANCE_ID

          if grep -q "init done" /etc/fstab; then
            echo "Filesystems have been already initialized. Skipping..."
          else
            echo "Setting up data partition..."
            if [ -b "$DATA_DEVICE" ]; then
              if file -sL $DATA_DEVICE | grep -q 'ext4 filesystem data'; then
                echo "There's already an ext4 filesystem on $DATA_DEVICE."
              else
                echo "No filesystem on $DATA_DEVICE. Formatting..."
                mkfs.ext4 "$DATA_DEVICE"
                echo "Format done."
              fi
            else
              echo "ERROR: $DATA_DEVICE doesn't seem to be a block device."
            fi

            echo "Setting up swap..."
            if [ -b "$SWAP_DEVICE" ]; then
              mkswap "$SWAP_DEVICE"
            else
              echo "$SWAP_DEVICE is not a block device. Aborting..."
            fi

            DATA_UUID=$(blkid $DATA_DEVICE -sUUID -ovalue)
            SWAP_UUID=$(blkid $SWAP_DEVICE -sUUID -ovalue)

            echo "Flagging fstab..."
            echo "# init done" >> /etc/fstab

            echo "Mounting partitions..."
            mount -a
            swapon -a
            mount
            swapon -s
          fi

          function external_dir() {
            local LOCAL_DIR="$1"
            local EXTERNAL_DIR="$DATA_MOUNTPOINT$LOCAL_DIR"

            echo "external_dir(): $LOCAL_DIR --> $EXTERNAL_DIR"

            if readlink $LOCAL_DIR; then
              echo "$LOCAL_DIR is already a symlink."
              EXTERNAL_DIR_RESULT="false"
            else
              if [ -d "$EXTERNAL_DIR" ]; then
                echo "$EXTERNAL_DIR already exists, skipping move and removing $LOCAL_DIR..."
                rm -rf "$LOCAL_DIR"
              else
                echo "Current contents of $LOCAL_DIR:"
                ls -lah "$LOCAL_DIR"
                echo "Moving $LOCAL_DIR to $EXTERNAL_DIR..."
                mkdir -p "$EXTERNAL_DIR"
                shopt -s dotglob
                mv $LOCAL_DIR/* "$EXTERNAL_DIR/"
                rm -rf "$LOCAL_DIR"
              fi
              echo "Linking $EXTERNAL_DIR to $LOCAL_DIR..."
              ln -s "$EXTERNAL_DIR" "$LOCAL_DIR"
              EXTERNAL_DIR_RESULT="true"
            fi
          }

          if mountpoint -q $DATA_MOUNTPOINT; then
            external_dir "/srv/www"
            external_dir "/etc/letsencrypt"
            external_dir "/etc/nginx"
            if [ "$EXTERNAL_DIR_RESULT" == "true" ]; then
              systemctl restart nginx
            fi
            external_dir "/var/awslogs/etc"
            if [ "$EXTERNAL_DIR_RESULT" == "true" ]; then
              systemctl restart awslogs
            fi

            external_dir "/etc/wsman-sites"

            WSMAN_PATH="$DATA_MOUNTPOINT/wsman/wsman"
            if [ -x "$WSMAN_PATH" ]; then
              echo "Running wsman generate..."
              $WSMAN_PATH generate
            else
              echo "Couldn't find/execute wsman at $WSMAN_PATH. SITES WILL NOT WORK! YOU HAVE TO FIX THIS MANUALLY!"
            fi

            INSTANCE_REBUILD_SCRIPT="$DATA_MOUNTPOINT/instance-rebuild.sh"
            if [ -x "$INSTANCE_REBUILD_SCRIPT" ]; then
              echo "Executing instance rebuild script ($INSTANCE_REBUILD_SCRIPT)"
              $INSTANCE_REBUILD_SCRIPT
            else
              echo "No instance rebuild script found ($INSTANCE_REBUILD_SCRIPT), skipping..."
            fi
          else
            echo "ERROR: $DATA_MOUNTPOINT is still not mounted. SITES WILL NOT WORK! YOU HAVE TO FIX THIS MANUALLY!"
          fi

          /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --resource WebInstance --region ${AWS::Region}
    Metadata:
      AWS::CloudFormation::Init:
        config:
          files:
            /etc/cfn/cfn-hup.conf:
              content: !Sub |
                [main]
                stack=${AWS::StackId}
                region=${AWS::Region}
                verbose=true
                interval=5
              mode: "000400"
              owner: root
              group: root
            /etc/cfn/hooks.d/cfn-auto-reloader.conf:
              content: !Sub |
                [cfn-auto-reloader-hook]
                triggers=post.update
                path=Resources.WebInstance.Metadata.AWS::CloudFormation::Init
                action=/opt/aws/bin/cfn-init -v --stack ${AWS::StackName} --resource WebInstance --region ${AWS::Region}
              mode: "000400"
              owner: root
              group: root
            /etc/systemd/system/cfn-hup.service:
              content: !Sub |
                [Unit]
                Description=cfn-hup daemon

                [Service]
                Type=simple
                ExecStart=/opt/aws/bin/cfn-hup
                Restart=always

                [Install]
                WantedBy=multi-user.target
              mode: "000400"
              owner: root
              group: root
            /var/awslogs/etc/config/system-logs.conf:
              mode: "000600"
              owner: root
              group: root
              content: !Sub |
                [/var/log/auth.log]
                log_group_name = ${AWS::StackName}/var/log/auth.log
                log_stream_name = {instance_id}
                file = /var/log/auth.log
            /opt/generate-hosting-env.sh:
              mode: "000700"
              owner: root
              group: root
              content: !Sub |
                #!/bin/bash

                HOSTING_ENV_FILE="/etc/wsman-sites/hosting-env"

                mkdir -p $(dirname $HOSTING_ENV_FILE)

                INSTANCE_ID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)
                PUBLIC_IPV4=$(curl http://169.254.169.254/latest/meta-data/public-ipv4)
                AVAIL_ZONE=$(curl http://169.254.169.254/latest/meta-data/placement/availability-zone)
                AWS_REGION="$(echo $AVAIL_ZONE | sed 's/.$//')"

                echo "INSTANCE_ID=$INSTANCE_ID" > $HOSTING_ENV_FILE
                echo "PUBLIC_IPV4=$PUBLIC_IPV4" >> $HOSTING_ENV_FILE
                echo "AVAIL_ZONE=$AVAIL_ZONE" >> $HOSTING_ENV_FILE
                echo "AWS_REGION=$AWS_REGION" >> $HOSTING_ENV_FILE
                echo "DB_HOST=${WebDBInstance.Endpoint.Address}" >> $HOSTING_ENV_FILE
                echo "DB_PORT=${WebDBInstance.Endpoint.Port}" >> $HOSTING_ENV_FILE
                echo "SMTP_HOST=${SMTPHostname}" >> $HOSTING_ENV_FILE
                echo "SMTP_PORT=${SMTPPort}" >> $HOSTING_ENV_FILE
                echo "SMTP_TLS=${SMTPTLS}" >> $HOSTING_ENV_FILE
                echo "ELASTICACHE_CONFIG_HOST=${ElastiCacheCluster.ConfigurationEndpoint.Address}" >> $HOSTING_ENV_FILE
                echo "ELASTICACHE_CONFIG_PORT=${ElastiCacheCluster.ConfigurationEndpoint.Port}" >> $HOSTING_ENV_FILE
                echo "MEMCACHED_HOST=$(echo '${ElastiCacheCluster.ConfigurationEndpoint.Address}' | sed 's/\.cfg\./.0001./')" >> $HOSTING_ENV_FILE
                echo "MEMCACHED_PORT=${ElastiCacheCluster.ConfigurationEndpoint.Port}" >> $HOSTING_ENV_FILE

                chmod 0400 $HOSTING_ENV_FILE
            /opt/generate-my-cnf.sh:
              mode: "000700"
              owner: root
              group: root
              content: !Sub |
                #!/bin/bash

                MYSQL_CLIENT_CNF="/root/.my.cnf"

                AVAIL_ZONE=$(curl http://169.254.169.254/latest/meta-data/placement/availability-zone)
                AWS_REGION="$(echo $AVAIL_ZONE | sed 's/.$//')"

                /var/awslogs/bin/aws configure set default.region $AWS_REGION

                echo "[client]" > $MYSQL_CLIENT_CNF
                echo "host=${WebDBInstance.Endpoint.Address}" >> $MYSQL_CLIENT_CNF
                echo "user=${DBUser}" >> $MYSQL_CLIENT_CNF
            /opt/get-db-password.sh:
              mode: "000700"
              owner: root
              group: root
              content: !Sub |
                #!/bin/bash

                echo "${DBPassword}"
            /opt/stack-name.sh:
              mode: "000700"
              owner: root
              group: root
              content: !Sub |
                #!/bin/bash

                echo "${AWS::StackName}"
          commands:
            01_enable_start_cfn-hup:
              command: "systemctl enable --now cfn-hup"
            02_restart_awslogs:
              command: "systemctl restart awslogs"
            03_hosting_env:
              command: "/opt/generate-hosting-env.sh"
            04_generate_my_cnf:
              command: "/opt/generate-my-cnf.sh"

  WebInstanceSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Web instance security group
      VpcId: !Ref MainVPC
      SecurityGroupIngress:
        - CidrIp: !Ref SSHLocation
          IpProtocol: tcp
          FromPort: 22
          ToPort: 22
        - CidrIp: "0.0.0.0/0"
          IpProtocol: tcp
          FromPort: 80
          ToPort: 80
        - CidrIp: "0.0.0.0/0"
          IpProtocol: tcp
          FromPort: 443
          ToPort: 443

  WebInstanceEIP:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc

  WebInstanceEIPAssociation:
    Condition: cCreateWebInstance
    Type: AWS::EC2::EIPAssociation
    Properties:
      AllocationId: !GetAtt WebInstanceEIP.AllocationId
      InstanceId: !Ref WebInstance

  WebDBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Subnet group for WebDBInstance.
      SubnetIds: [ !Ref DBSubnet1, !Ref DBSubnet2 ]

  WebDBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Join ['-', [!Ref 'AWS::StackName', WebDBSecurityGroup]]
      GroupDescription: "Allow DB access to anything attached to this Security Group."
      Tags:
        - Key: Name
          Value: !Join ['-', [!Ref 'AWS::StackName', WebDBSecurityGroup]]
      VpcId: !Ref MainVPC

  WebDBSecurityGroupIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !GetAtt WebDBSecurityGroup.GroupId
      IpProtocol: tcp
      FromPort: 3306
      ToPort: 3306
      SourceSecurityGroupId: !GetAtt WebDBSecurityGroup.GroupId

  WebDBParameterGroup:
    Type: AWS::RDS::DBParameterGroup
    Properties:
      Description: Parameter group for WebDB.
      Family: !Ref DBParameterGroupFamily
      Parameters:
        collation_server: utf8mb4_unicode_ci
        character_set_server: utf8mb4

  WebDBInstance:
    Type: AWS::RDS::DBInstance
    Properties:
      DBName: !Ref DBName
      AllocatedStorage: !Ref DBAllocatedStorage
      DBInstanceClass: !Ref DBInstanceClass
      Engine: "MySQL"
      EngineVersion: !Ref MySQLVersion
      StorageType: gp2
      StorageEncrypted: true
      KmsKeyId: !GetAtt EncryptionKey.Arn
      MasterUsername: !Ref DBUser
      MasterUserPassword: !Ref DBPassword
      AutoMinorVersionUpgrade: true
      AvailabilityZone: !Ref WebAZ
      BackupRetentionPeriod: !Ref DBBackupRetentionPeriod
      CopyTagsToSnapshot: true
      VPCSecurityGroups: [ !Ref WebDBSecurityGroup ]
      DBSubnetGroupName: !Ref WebDBSubnetGroup
      DBParameterGroupName: !Ref WebDBParameterGroup
      Tags:
        - Key: Name
          Value: !Join ['-', [!Ref 'AWS::StackName', WebDBInstance]]

  EncryptionKey:
    Type: AWS::KMS::Key
    Properties:
      Description: This key is used to encrypt the RDS database and EBS volumes of the web stack.
      Enabled: true
      EnableKeyRotation: false
      KeyPolicy:
        Version: "2012-10-17"
        Id: "key-default-1"
        Statement:
          - Sid: "Enable IAM User Permissions"
            Effect: Allow
            Principal:
              AWS: !Join ['', ['arn:aws:iam::', !Ref 'AWS::AccountId', ':root']]
            Action: "kms:*"
            Resource: "*"
          - Sid: "Allow access for Key Administrators"
            Effect: Allow
            Principal:
              AWS: !Join ['', ['arn:aws:iam::', !Ref 'AWS::AccountId', ':root']]
            Action: "kms:*"
            Resource: "*"
          - Sid: "Allow use of the key"
            Effect: Allow
            Principal:
              AWS:
                - !Join ['', ['arn:aws:iam::', !Ref 'AWS::AccountId', ':role/aws-service-role/rds.amazonaws.com/AWSServiceRoleForRDS']]
            Action:
              - "kms:Encrypt"
              - "kms:Decrypt"
              - "kms:ReEncrypt*"
              - "kms:GenerateDataKey*"
              - "kms:DescribeKey"
            Resource: "*"
          - Sid: "Allow attachment of persistent resources"
            Effect: Allow
            Principal:
              AWS:
                - !Join ['', ['arn:aws:iam::', !Ref 'AWS::AccountId', ':role/aws-service-role/rds.amazonaws.com/AWSServiceRoleForRDS']]
            Action:
              - "kms:CreateGrant"
              - "kms:ListGrants"
              - "kms:RevokeGrant"
            Resource: "*"
            Condition:
             Bool:
              "kms:GrantIsForAWSResource": true

  EncryptionKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Join ['', ['alias/', !Ref 'AWS::StackName', '-key']]
      TargetKeyId:
        Ref: EncryptionKey

  InboundElastiCacheRule:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      IpProtocol: tcp
      FromPort: 11211
      ToPort: 11211
      SourceSecurityGroupId: !GetAtt ElastiCacheSecurityGroup.GroupId
      GroupId: !GetAtt WebInstanceSecurityGroup.GroupId

  ElastiCacheSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: ElastiCache Security Group
      VpcId: !Ref MainVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 11211
          ToPort: 11211
          SourceSecurityGroupId: !Ref WebInstanceSecurityGroup
      Tags:
      - Key: Name
        Value: !Join ['-', [!Ref 'AWS::StackName', ElastiCacheSecurityGroup]]

  ElastiCacheSubnetGroup:
    Type: AWS::ElastiCache::SubnetGroup
    Properties:
      Description: Cache Subnet Group
      SubnetIds:
        - !Ref DBSubnet1

  ElastiCacheCluster:
    Type: AWS::ElastiCache::CacheCluster
    Properties:
      AZMode: single-az
      Engine: memcached
      EngineVersion: !Ref MemcachedVersion
      NumCacheNodes: 1
      CacheNodeType: !Ref CacheNodeType
      VpcSecurityGroupIds: [ !Ref ElastiCacheSecurityGroup ]
      CacheSubnetGroupName: !Ref ElastiCacheSubnetGroup
      Tags:
      - Key: Name
        Value: !Join ['-', [!Ref 'AWS::StackName', ElastiCacheCluster]]

Outputs:
  WebInstanceIP:
    Condition: cCreateWebInstance
    Description: Elastic IP address of the web instance. Set A records to point to this IP address.
    Value: !GetAtt WebInstance.PublicIp
